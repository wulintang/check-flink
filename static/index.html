<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>友链状态检测</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#6366F1',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.04)',
                    }
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-transition {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-dark font-sans text-base">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 页头 -->
        <header class="text-center mb-8 pb-4 border-b border-gray-100">
            <h1 class="text-2xl font-bold text-dark mb-2">友链状态检测</h1>
            <p class="text-gray-500">按加载速度排序 · 错误链接在底部</p>
        </header>
        
        <!-- 状态统计（保持4个卡片） -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- 总链接数 -->
            <div class="bg-white rounded-lg shadow-card p-5 card-transition hover:shadow-card-hover hover:-translate-y-1">
                <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider mb-2">总链接数</h3>
                <div class="text-xl font-bold text-primary" id="total-count">加载中...</div>
            </div>
            
            <!-- 正常链接 -->
            <div class="bg-white rounded-lg shadow-card p-5 card-transition hover:shadow-card-hover hover:-translate-y-1">
                <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider mb-2">正常链接</h3>
                <div class="text-xl font-bold text-success" id="accessible-count">加载中...</div>
            </div>
            
            <!-- 错误链接 -->
            <div class="bg-white rounded-lg shadow-card p-5 card-transition hover:shadow-card-hover hover:-translate-y-1">
                <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider mb-2">错误链接</h3>
                <div class="text-xl font-bold text-danger" id="inaccessible-count">加载中...</div>
            </div>
            
            <!-- 最后检测时间 -->
            <div class="bg-white rounded-lg shadow-card p-5 card-transition hover:shadow-card-hover hover:-translate-y-1">
                <h3 class="text-gray-500 text-sm font-medium uppercase tracking-wider mb-2">最后检测时间</h3>
                <div class="text-xl font-bold text-warning" id="timestamp">加载中...</div>
            </div>
        </div>
        
        <!-- 链接卡片网格（保持4列布局） -->
        <div id="links-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- 加载状态 -->
            <div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-500">
                <div class="w-10 h-10 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div>
                <p>正在从API加载数据...</p>
            </div>
        </div>
        
        <!-- 页脚（包含访问量统计，底部展示） -->
        <footer class="text-center text-gray-500 pt-6 border-t border-gray-100">
            <div class="mb-4">
                <p class="inline-block mr-6">
                    网站总请求量：<span id="vercount_value_site_pv" class="font-medium text-info">0</span>
                </p>
                <p class="inline-block">
                    独立访客数：<span id="vercount_value_site_uv" class="font-medium text-info">0</span>
                </p>
            </div>
            <p>数据来源: <a href="https://www.dao.js.cn" class="text-primary hover:underline font-medium" target="_blank">懋和道人</a>、技术支撑<a href="https://www.liushen.fun/" class="text-primary hover:underline font-medium" target="_blank">清羽飞扬</a></p>
            <p>所属地址：<a href="https://github.com/willow-god/check-flink" class="text-primary hover:underline font-medium" target="_blank">check-flink</a></p>
        </footer>
    </div>

    <script>
        // 1. 访问量统计（使用localStorage持久化，关闭浏览器不丢失）
        function initTrafficStats() {
            // 从本地存储获取数据，没有则初始化
            const stats = JSON.parse(localStorage.getItem('siteTrafficStats')) || {
                pv: 0,  // 总请求量
                uv: 0,  // 独立访客数
                lastVisit: null
            };
            
            // 生成唯一访客标识（简单实现）
            const visitorId = localStorage.getItem('visitorId');
            if (!visitorId) {
                // 新访客，生成唯一ID并存储
                localStorage.setItem('visitorId', Math.random().toString(36).substr(2, 9));
                stats.uv += 1;  // 新访客UV+1
            }
            
            // 每次访问PV+1
            stats.pv += 1;
            stats.lastVisit = new Date().toISOString();
            
            // 保存到本地存储（持久化）
            localStorage.setItem('siteTrafficStats', JSON.stringify(stats));
            
            // 更新页面显示
            document.getElementById('vercount_value_site_pv').textContent = stats.pv.toLocaleString();
            document.getElementById('vercount_value_site_uv').textContent = stats.uv.toLocaleString();
        }
        
        // 2. 初始化友链数据
        function initLinkData() {
            fetch('/result.json')
                .then(response => {
                    if (!response.ok) throw new Error('网络响应异常');
                    return response.json();
                })
                .then(data => {
                    // 更新友链统计
                    document.getElementById('total-count').textContent = data.total_count;
                    document.getElementById('accessible-count').textContent = data.accessible_count;
                    document.getElementById('inaccessible-count').textContent = data.inaccessible_count;
                    document.getElementById('timestamp').textContent = data.timestamp;
                    
                    // 处理链接排序
                    const workingLinks = data.link_status.filter(link => link.fail_count === 0);
                    const errorLinks = data.link_status.filter(link => link.fail_count > 0);
                    workingLinks.sort((a, b) => a.latency - b.latency);
                    errorLinks.sort((a, b) => b.fail_count - a.fail_count);
                    const sortedLinks = [...workingLinks, ...errorLinks];
                    
                    // 渲染链接卡片
                    const linksContainer = document.getElementById('links-container');
                    linksContainer.innerHTML = '';
                    
                    sortedLinks.forEach((link, index) => {
                        const isSuccess = link.fail_count === 0;
                        const linkCard = document.createElement('a');
                        linkCard.href = link.link;
                        linkCard.target = '_blank';
                        linkCard.className = `
                            bg-white rounded-lg shadow-card p-5 card-transition hover:shadow-card-hover hover:-translate-y-1
                            flex flex-col h-full
                        `;
                        
                        // 渐入动画
                        linkCard.style.opacity = '0';
                        linkCard.style.transform = 'translateY(10px)';
                        
                        linkCard.innerHTML = `
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-base font-semibold text-dark hover:text-primary transition-colors line-clamp-1">
                                    ${link.name}
                                </h3>
                                <span class="flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    ${isSuccess ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}">
                                    <span class="w-1.5 h-1.5 rounded-full mr-1 ${isSuccess ? 'bg-success' : 'bg-danger'}"></span>
                                    ${isSuccess ? '正常' : '错误'}
                                </span>
                            </div>
                            <div class="flex items-center text-gray-500 text-sm mt-auto pt-3 border-t border-gray-50">
                                <i class="fa fa-clock-o mr-2 text-warning"></i>
                                <span>${isSuccess ? link.latency + ' s' : '-'}</span>
                            </div>
                        `;
                        
                        linksContainer.appendChild(linkCard);
                        
                        // 触发动画
                        setTimeout(() => {
                            linkCard.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                            linkCard.style.opacity = '1';
                            linkCard.style.transform = 'translateY(0)';
                        }, 60 * index);
                    });
                })
                .catch(error => {
                    console.error('友链数据加载失败:', error);
                    const linksContainer = document.getElementById('links-container');
                    linksContainer.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-500">
                            <div class="w-10 h-10 text-danger mb-3">
                                <i class="fa fa-exclamation-circle text-2xl"></i>
                            </div>
                            <p>加载数据失败: ${error.message}</p>
                        </div>
                    `;
                });
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            initTrafficStats();  // 初始化访问量统计（持久化）
            initLinkData();      // 初始化友链数据
        });
    </script>
</body>
</html>
